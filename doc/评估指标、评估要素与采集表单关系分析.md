# 评估指标、评估要素与采集表单关系分析（以本项目实现为准）

本文档以当前仓库的**实际实现**为准（主要参考 `backend/routes/*.js`、`backend/services/*.js`、`backend/database/schema.sql`、`frontend/src/services/*.ts`），用于说明以下核心概念之间的关系与数据如何流动：

- **评估指标体系**（Indicator System / Indicator / Data Indicator）
- **评估要素库**（Element Library / Element，支持基础要素与派生要素）
- **采集表单/问卷**（Data Tool + schema 字段定义）
- **字段映射**（Field Mapping：表单字段 → 数据指标/要素）
- **指标采集值落库**（School Indicator Data：项目×学校×数据指标的采集值与达标结果）
- **资源配置 7 项指标与综合达标**（内置统计模型，独立于指标体系）

---

## 一、概念定义与边界（哪些走指标体系，哪些是内置统计）

| 概念 | 在系统中的含义 | 主要存储/来源 | 关键说明 |
|---|---|---|---|
| **评估项目 (Project)** | 一次评估活动的“容器”，组织指标体系与采集工具，驱动填报/评审/统计 | `projects` | 项目状态：`配置中 → 填报中 → 评审中 → 已完成/已中止` |
| **指标体系 (Indicator System)** | 评估标准集合（树结构） | `indicator_systems` + `indicators` | 三级结构通过 `indicators.parent_id` 维护 |
| **指标节点 (Indicator)** | 指标体系树上的节点（1/2/3级） | `indicators` | 末级节点 `is_leaf=1` 才能配置数据指标与佐证资料 |
| **数据指标 (Data Indicator)** | 末级指标下的“可采集/可判定”量化项，带阈值字符串 | `data_indicators` | 核心字段：`threshold`（字符串，如 `≥4.2` / `≤17:1` / `>=95%`） |
| **佐证资料 (Supporting Material)** | 对末级指标的附件要求配置 | `supporting_materials` | 提交时可产生上传记录（见 submissions 相关路由） |
| **要素库/要素 (Element)** | 可复用的数据定义：基础要素（直接采集）/派生要素（公式） | `element_libraries` + `elements` | 派生要素的 `formula` 会在指标同步时被解析计算 |
| **采集工具 (Data Tool)** | 表单或问卷（schema 定义字段结构） | `data_tools.schema` | schema 为 JSON 字符串，字段 id 用作映射主键 |
| **字段映射 (Field Mapping)** | 表单字段与“数据指标/要素”的绑定关系 | `field_mappings` | `mapping_type = 'data_indicator' | 'element'`，同一 `(tool_id, field_id)` 唯一 |
| **数据指标-要素关联** | 数据指标与要素之间的多对多关系，用于说明“指标依赖哪些要素”及公式计算入口 | `data_indicator_elements` | `mapping_type = 'primary' | 'reference'`；公式计算时只用 `primary` 的派生要素 |
| **指标采集值（落库）** | 某项目某学校某数据指标的采集值、达标结果 | `school_indicator_data` | 由 `submissions` 解析/计算后写入（见 `syncSubmissionIndicators`） |
| **资源配置 7 项指标** | 区县工作台用的固定 7 项资源指标（L1-L7） | `backend/routes/statistics.js` | **内置模型**：直接读取 submission 的约定字段计算，不依赖指标体系/字段映射 |

---

## 二、总体关系图（实现视角）

```
┌───────────────────────────────┐
│           项目 Project         │
│ projects.indicator_system_id   │
│ projects.status (配置中/...)   │
└───────────────┬───────────────┘
                │ 1:1
                ▼
┌───────────────────────────────┐
│       指标体系 IndicatorSystem │
│ indicator_systems             │
└───────────────┬───────────────┘
                │ 1:N
                ▼
┌───────────────────────────────┐
│   指标节点 Indicator(树)        │
│ indicators (parent_id 自引用)   │
└───────────────┬───────────────┘
                │ (末级 is_leaf=1)
         ┌──────┴────────┐
         ▼               ▼
┌────────────────┐  ┌─────────────────────┐
│ 数据指标        │  │ 佐证资料配置         │
│ data_indicators │  │ supporting_materials│
└───────┬────────┘  └─────────────────────┘
        │  N:M (说明/计算依赖)
        ▼
┌───────────────────────────────┐
│  数据指标-要素关联             │
│ data_indicator_elements        │
│ mapping_type: primary/reference│
└───────────────┬───────────────┘
                │ N:1
                ▼
┌───────────────────────────────┐
│     要素 Element（基础/派生）   │
│ elements (formula/aggregation) │
└───────────────────────────────┘

┌───────────────────────────────┐
│     采集工具 DataTool(表单/问卷)│
│ data_tools.schema (JSON)       │
└───────────────┬───────────────┘
                │ schema 字段(field_id)
                ▼
┌───────────────────────────────┐
│     字段映射 field_mappings     │
│ mapping_type: data_indicator    │
│              | element          │
└───────┬─────────────┬─────────┘
        │             │
        ▼             ▼
  data_indicators   elements

┌───────────────────────────────┐
│   填报记录 Submission           │
│ submissions(project_id,school_id,...)│
│ data(JSON) + status(draft/...)  │
└───────────────┬───────────────┘
                │ 同步/计算（后端）
                ▼
┌───────────────────────────────┐
│ 指标采集值 school_indicator_data│
│ value/text_value + is_compliant │
└───────────────────────────────┘
```

---

## 三、关键数据结构（以数据库/接口字段为主）

### 3.1 指标体系与指标树

- **indicator_systems**
  - `id, name, type(达标类|评分类), target, tags(JSON字符串), attachments(JSON字符串), status(draft|editing|published)`
- **indicators**
  - `id, system_id, parent_id, code, name, level(1|2|3), is_leaf(0|1), weight, sort_order`
- **data_indicators**
  - `id, indicator_id(末级指标), code, name, threshold, description, data_source, sort_order`
- **supporting_materials**
  - `id, indicator_id, code, name, required(0|1), file_types, max_size, description`

### 3.2 要素库与要素（基础/派生）

- **element_libraries**
  - `id, name, description, status(draft|published), element_count`
- **elements**
  - `id, library_id, code, name, element_type(基础要素|派生要素), data_type`
  - 基础要素可包含：`tool_id, field_id, field_label`
  - 派生要素可包含：`formula`
  - 多次提交聚合：`aggregation(JSONB)`（用于扩展/高级统计）

### 3.3 字段映射（表单字段 → 数据指标/要素）

- **field_mappings**
  - `tool_id, field_id, mapping_type('data_indicator'|'element'), target_id`
  - 可选回显字段：`field_label`
  - 唯一约束：`UNIQUE(tool_id, field_id)`

### 3.4 数据指标-要素关联（指标依赖哪些要素）

- **data_indicator_elements**
  - `data_indicator_id, element_id, mapping_type('primary'|'reference')`
  - 说明：`primary` 常用于“该数据指标由某个派生要素（带 formula）计算得到”的入口关联

### 3.5 指标采集值落库（项目×学校×数据指标）

- **school_indicator_data**
  - 唯一键：`(project_id, school_id, data_indicator_id)`
  - 值：`value(数值)` / `text_value(文本)`
  - 判定：`is_compliant`（1=达标，0=未达标，NULL=无法判断）
  - 溯源：`submission_id, collected_at`

---

## 四、从表单到“数据指标值”的两条实现路径（核心）

后端在同步指标时（`syncSubmissionIndicators`）支持两条路径：

### 4.1 直接映射：字段 → 数据指标

1. `field_mappings` 中配置：`mapping_type='data_indicator'`
2. 从 submission 的 `data(JSON)` 中按 `field_id` 取值
   - 支持 **扁平 key**（例如 key 本身包含点号）以及 **a.b.c 路径**读取
   - 若路径中遇到数组，会对数组中对应字段的数值**求和**
3. 写入 `school_indicator_data` 并根据 `data_indicators.threshold` 进行达标判定

### 4.2 要素映射 + 派生公式：字段 → 要素 → 公式 → 数据指标

1. `field_mappings` 中配置：`mapping_type='element'`（字段采集到基础要素）
2. 提取 element 值时仅保留**可解析为数值**的字段（文本/布尔等会被忽略为不可计算）
3. 查找当前项目指标体系下，存在 `data_indicator_elements(mapping_type='primary')` 且关联要素 `elements.formula` 非空的数据指标
4. 公式计算：
   - 公式变量形如 `E001` / `D001`（正则：`[ED]\\d{3}`），会被替换为对应 elementCode 的数值
   - 仅允许数字、四则运算与括号，安全校验后执行
5. 若某数据指标已有“直接映射”的值，则**公式结果不会覆盖**
6. 写入 `school_indicator_data` 并做阈值达标判定

---

## 五、资源配置 7 项指标与综合达标（区县工作台，内置模型）

### 5.1 重要说明：这是“内置统计”，不走指标体系/字段映射

资源配置 7 项指标（L1-L7）与综合达标规则由 `backend/routes/statistics.js` **硬编码配置与计算**，其数据来源是：

- `schools`（用于兜底展示的 student_count 等）
- `submissions`（按区县、项目、学校取一条“有效 submission”解析 `data` 后计算）

因此它与“指标体系/数据指标/要素/映射”是**并行的两条线**：  
指标体系线用于通用评估与 `school_indicator_data`；资源指标线用于区县工作台的特定模型。

### 5.2 submission 选取与缺失值策略（避免误导）

对每所学校：

- **只选 `approved/submitted/rejected`**，不纳入 `draft`
- **优先 `approved`**，若无则回退到**最新**的 `submitted/rejected`
- 若完全没有有效 submission：L1-L7 的 `value/isCompliant` 返回 **null**（避免把缺失当 0）

### 5.3 指标计算要点（实现口径）

- 学生数：
  - 小学：`primary_student_count` 优先，否则 `student_count`
  - 初中：`junior_student_count` 优先，否则 `student_count`
- L1（高学历教师）：
  - 小学：`primary_college_degree_teacher_count + primary_bachelor_degree_teacher_count + primary_master_degree_teacher_count + primary_doctor_degree_teacher_count`
  - 初中：`junior_bachelor_degree_teacher_count + junior_master_degree_teacher_count + junior_doctor_degree_teacher_count`
  - 指标值：\( \frac{高学历教师数}{学生数} \times 100 \)
- L2（骨干教师）：\( \frac{县级骨干教师数}{学生数} \times 100 \)
- L3（体艺教师）：体育+音乐+美术教师数 / 学生数 ×100
- L4（教学及辅助用房）：教学及辅助用房面积 / 学生数
- L5（体育运动场馆）：体育运动场馆面积 / 学生数
- L6（仪器设备值）：设备值（万元）×10000 / 学生数
- L7（多媒体教室）：多媒体教室数 / 学生数 ×100

### 5.4 综合达标规则（实现口径）

配置（实现中带有 `thresholdMin`，即标准的 85%）：

- **至少 6 项达标**
- 其余未达标项必须 **不低于标准的 85%**

并且会返回：

- `overallComplianceMessage`：如 `综合达标：6/7项达标` 或 `综合未达标：达标项仅5项（需至少6项）；1项低于标准的85%`
- `overallComplianceDetails`：逐条解释未达标项是否低于 85% 下限

### 5.5 一体化学校展示处理

当学校类型为 `九年一贯制` 或 `完全中学` 时，按学段统计时会在名称后追加：

- 小学口径：`（小学部）`
- 初中口径：`（初中部）`

### 5.6 接口（以路由挂载为准）

后端统一挂载在 `/api` 下：

- `GET /api/districts/:districtId/resource-indicators-summary?projectId=...&schoolType=小学|初中`

返回结构（关键字段）：

```json
{
  "code": 200,
  "data": {
    "district": { "id": "...", "name": "...", "code": "..." },
    "schoolType": "小学",
    "summary": {
      "schoolCount": 12,
      "cvIndicators": [
        { "code": "L1", "name": "...", "cv": 0.32, "mean": 4.8, "stdDev": 1.2, "count": 12, "threshold": 0.50, "isCompliant": true }
      ],
      "overallCompliance": {
        "rule": "每所学校至少6项指标达标，余项不低于标准的85%",
        "minCompliantCount": 6,
        "minThresholdPercent": 0.85,
        "compliantSchools": 10,
        "nonCompliantSchools": 2,
        "pendingSchools": 0,
        "complianceRate": 83.33,
        "allSchoolsCompliant": false
      }
    },
    "schools": [
      {
        "id": "...",
        "name": "...",
        "submissionStatus": "approved",
        "submittedAt": "2025-12-18T09:22:51.278Z",
        "studentCount": 1200,
        "indicators": {
          "L1": { "value": 4.8, "threshold": 4.2, "isCompliant": true },
          "L2": { "value": 1.2, "threshold": 1.0, "isCompliant": true }
        },
        "isOverallCompliant": true,
        "overallComplianceMessage": "综合达标：7/7项达标",
        "overallComplianceDetails": []
      }
    ]
  }
}
```

---

## 六、差异系数（CV）相关实现口径

系统中至少存在两类 CV 计算输出：

1. **项目 CV 分析接口**（面向项目维度）  
   - `GET /api/projects/:projectId/cv-analysis?districtId=...&schoolType=小学|初中`  
   - 返回：以生师比为主（并可能扩展到 `school_indicator_data` 中的更多指标）
2. **资源配置 7 项指标汇总中的 CV**（面向区县工作台）  
   - 与 L1-L7 数值序列相关；当样本数 < 2 时 `cv=null`

---

## 七、关键代码位置（便于二次核对）

| 主题 | 关键文件 | 说明 |
|---|---|---|
| 指标体系/指标树/数据指标/佐证资料 | `backend/routes/indicators.js` | 含数据指标-要素关联 CRUD |
| 要素库/要素/字段映射 | `backend/routes/tools.js` | `field_mappings` CRUD + `full-schema` 聚合接口 |
| 提交解析与指标同步落库 | `backend/routes/submissions.js` | `syncSubmissionIndicators`（直接映射 + 公式计算） |
| 资源配置 7 项与综合达标 | `backend/routes/statistics.js` | `/districts/:districtId/resource-indicators-summary` |
| 前端统计接口封装 | `frontend/src/services/statisticsService.ts` | 调用 `/districts/:districtId/resource-indicators-summary` |


