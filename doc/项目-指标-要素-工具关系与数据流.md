# 项目-指标-要素-工具关系与数据流（以本项目实现为准）

本文档描述教育督导评估系统中「项目」「指标体系」「要素库」「采集工具」之间的真实关系与数据流动，并补充当前实现中的两个关键点：

1. **指标采集值会落库到 `school_indicator_data`**（用于达标率/统计等通用计算）
2. **区县工作台的“资源配置 7 项指标 + 综合达标”是内置统计模型**（直接读 submission 的约定字段，不走指标体系/字段映射）

后端路由统一挂载在 `/api` 下（见 `backend/index.js` / `backend/app.js`）。

---

## 一、核心概念与边界

| 概念 | 说明 | 主要表/接口 | 边界说明 |
|---|---|---|---|
| **项目 (Project)** | 组织一次评估：绑定指标体系、配置工具、驱动填报与统计 | `projects` | 状态：`配置中/填报中/评审中/已完成/已中止` |
| **指标体系 (Indicator System)** | 评估标准集合（树结构） | `indicator_systems` + `indicators` | 定义“评什么、层级结构” |
| **数据指标 (Data Indicator)** | 末级指标下的量化项（阈值） | `data_indicators` | 阈值常以字符串存于 `threshold` |
| **要素库/要素 (Element)** | 可复用数据定义：基础/派生（公式） | `element_libraries` + `elements` | 派生要素 `formula` 可用于计算数据指标值 |
| **采集工具 (Data Tool)** | 表单/问卷，`schema` 定义字段结构 | `data_tools` | schema 中字段 `id` 作为 `field_id` |
| **字段映射 (Field Mapping)** | 工具字段与数据指标/要素的绑定 | `field_mappings` | `mapping_type = data_indicator | element` |
| **数据指标-要素关联** | 数据指标依赖哪些要素（primary/reference） | `data_indicator_elements` | 公式计算路径中会用到 `primary` 的派生要素 |
| **填报记录 (Submission)** | 某学校在某项目某工具的一次提交 | `submissions` | `data(JSON)` + `status(draft/submitted/approved/rejected)` |
| **指标采集值（落库）** | 项目×学校×数据指标的采集值与达标结果 | `school_indicator_data` | 由 submission 解析/计算后写入 |
| **资源配置 7 项指标** | 区县工作台专用统计 L1-L7 + 综合达标 | `backend/routes/statistics.js` | 与指标体系并行，不依赖映射/落库 |

---

## 二、实体关系图（实现视角）

```
projects (1) ── indicator_system_id ──> indicator_systems (1)
   │
   └─< project_tools (N) >─ data_tools (N)
                         │
                         └─< field_mappings (N)
                              ├─ mapping_type=data_indicator ──> data_indicators
                              └─ mapping_type=element ─────────> elements

indicator_systems (1) ──< indicators (N, parent_id 自引用树)
                          ├─< data_indicators (N)
                          │     └─< data_indicator_elements (N) >─ elements (N)
                          └─< supporting_materials (N)

submissions (N) ──(project_id, school_id, tool/form)─┐
                                                      └─ sync/计算 ──> school_indicator_data (N)
```

---

## 三、关键表与关键字段（按实现使用频率）

### 3.1 项目与状态流转

- `projects.status`：`配置中 → 填报中 → 评审中 → 已完成`（或任意状态可 `已中止`）
- 项目启动填报存在“必须已发布”的校验（实现中读取 `projects.is_published`）

### 3.2 指标体系（树）与数据指标

- `indicators` 扁平存储，通过 `parent_id` 形成树
- `data_indicators` 绑定末级指标（`indicator_id` 指向 `indicators.id`）
- 达标判定在“指标值同步”时基于 `data_indicators.threshold`（字符串阈值）进行

### 3.3 要素库、要素与公式

- `elements.element_type`：`基础要素 | 派生要素`
- `elements.formula`：派生要素公式；当前实现允许变量形如 `E001/D001`，仅允许数字与四则运算、括号

### 3.4 工具 schema 与字段映射（Field Mapping）

字段映射表结构：

- `field_mappings.tool_id`
- `field_mappings.field_id`（对应 schema 字段 id）
- `field_mappings.mapping_type`：`data_indicator | element`
- `field_mappings.target_id`：目标 id（数据指标 id 或要素 id）

### 3.5 数据指标-要素关联（Data Indicator Elements）

- `data_indicator_elements.mapping_type`：`primary | reference`
- 实现中的公式计算路径会按项目指标体系查询：**只取 `mapping_type='primary'` 且关联要素 `formula` 非空** 的数据指标作为“可计算指标”

### 3.6 Submission 与指标采集值落库

实现里存在一条核心链路：

- `submissions.data(JSON)` → 解析字段（支持扁平 key 与 `a.b.c` 路径，数组路径会求和）
- 写入/更新 `school_indicator_data`（upsert on `project_id,school_id,data_indicator_id`）
- 同步时计算 `is_compliant`（1/0/NULL）

---

## 四、数据流（配置 → 填报 → 指标同步 → 统计）

### 4.1 配置阶段数据流

```
创建指标体系 → 构建指标树(1/2/3级) → 末级配置数据指标/佐证资料
创建要素库 → 定义基础要素/派生要素(公式)
创建采集工具(schema) → 配置字段映射(field_mappings)
创建项目 → 关联指标体系 → 关联采集工具(project_tools) → 发布/启动填报
```

### 4.2 填报阶段数据流

```
学校/填报人 → 选择项目 + 工具 → 填写 schema 字段 → 生成 submissions(data,status,...)
```

### 4.3 指标同步阶段（把 submission 转成可统计的指标数据）

同步逻辑（实现支持两条路径）：

- **直接映射**：`field_mappings(mapping_type=data_indicator)` 直接把字段值写入对应 `data_indicator_id`
- **要素 + 公式计算**：
  - `field_mappings(mapping_type=element)` 提取基础要素数值
  - 查找 `data_indicator_elements(primary)` 关联到带 `formula` 的派生要素
  - 用公式计算得到数据指标值（若该指标已被直接映射提供值，则不覆盖）

最终落库：

- 写入 `school_indicator_data(value/text_value/is_compliant/submission_id/collected_at)`

### 4.4 统计阶段数据流（通用统计 vs 内置资源指标）

#### A. 通用统计（基于 `school_indicator_data`）

- 达标率统计：从 `school_indicator_data.is_compliant` 聚合
- 项目 CV 分析：以学校基础数据的生师比为基础，并可扩展到 `school_indicator_data` 中的更多指标

相关接口示例：

- `GET /api/projects/:projectId/compliance-summary`
- `GET /api/projects/:projectId/compliance-by-category`
- `GET /api/projects/:projectId/cv-analysis`
- `GET /api/projects/:projectId/cv-summary`

#### B. 区县工作台资源配置 7 项指标（内置模型）

特点：

- 不依赖指标体系/字段映射/`school_indicator_data`
- 直接读取 `submissions.data` 中约定字段计算 L1-L7
- submission 选择策略：优先 `approved`，否则最新 `submitted/rejected`，排除 `draft`；无有效 submission 时指标值返回 `null`
- 额外输出：每校综合达标（至少 6 项达标 + 其余≥85%）与 `overallComplianceDetails`

接口：

- `GET /api/districts/:districtId/resource-indicators-summary?projectId=...&schoolType=小学|初中`

---

## 五、页面/模块与数据关系（对照实现）

| 模块 | 前端页面/服务 | 后端路由 | 关键数据 |
|---|---|---|---|
| 指标体系管理 | `frontend/src/services/indicatorService.ts` | `backend/routes/indicators.js` | `indicator_systems / indicators / data_indicators / supporting_materials` |
| 数据指标-要素关联 | `indicatorService.ts`（elements 相关 API） | `indicators.js`（`/data-indicators/:id/elements`） | `data_indicator_elements` |
| 要素库/要素管理 | （要素库相关页面） | `backend/routes/tools.js`（elements CRUD） | `element_libraries / elements` |
| 工具与字段映射 | （工具编辑/字段映射 UI） | `backend/routes/tools.js`（`/tools/:id/field-mappings`、`/tools/:id/full-schema`） | `data_tools.schema + field_mappings` |
| 填报与指标同步 | （填报页面） | `backend/routes/submissions.js` | `submissions → school_indicator_data` |
| 区县工作台资源指标 | `frontend/src/pages/DistrictDashboard/components/IndicatorSummary.tsx` | `backend/routes/statistics.js` | `submissions + schools + 内置 L1-L7` |

---

## 六、文档使用建议（避免概念混用）

- 当你在讨论“某指标是否达标/达标率”等**通用评估**时：默认指 **指标体系 → 数据指标 → school_indicator_data** 这条链路。
- 当你在讨论“7 项资源配置指标、综合达标（6/7 + 85%）”时：默认指 **statistics.js 内置模型**，不需要配置映射，也不需要数据指标存在。


