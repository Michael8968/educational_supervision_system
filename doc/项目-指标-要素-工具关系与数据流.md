# 项目-指标-要素-工具关系与数据流（以本项目实现为准）

> **最后更新时间**：2025-12-22
> **校对版本**：v2.0
> **校对说明**：本次更新与《评估指标、评估要素与采集表单关系分析》文档同步校对，确保一致性

本文档描述教育督导评估系统中「项目」「指标体系」「要素库」「采集工具」之间的真实关系与数据流动，并补充当前实现中的两个关键点：

1. **指标采集值会落库到 `school_indicator_data`**（用于达标率/统计等通用计算）
2. **区县工作台的"资源配置 7 项指标 + 综合达标"是内置统计模型**（直接读 submission 的约定字段，不走指标体系/字段映射）

后端路由统一挂载在 `/api` 下（见 `backend/index.js` / `backend/app.js`）。

---

## 一、核心概念与边界

| 概念 | 说明 | 主要表/接口 | 边界说明 |
|---|---|---|---|
| **项目 (Project)** | 组织一次评估：绑定指标体系、配置工具、驱动填报与统计 | `projects` | 状态：`配置中/填报中/评审中/已完成/已中止` |
| **指标体系 (Indicator System)** | 评估标准集合（树结构） | `indicator_systems` + `indicators` | 定义“评什么、层级结构” |
| **数据指标 (Data Indicator)** | 末级指标下的量化项（阈值） | `data_indicators` | 阈值常以字符串存于 `threshold` |
| **要素库/要素 (Element)** | 可复用数据定义：基础/派生（公式） | `element_libraries` + `elements` | 派生要素 `formula` 可用于计算数据指标值 |
| **采集工具 (Data Tool)** | 表单/问卷，`schema` 定义字段结构 | `data_tools` | schema 中字段 `id` 作为 `field_id` |
| **字段映射 (Field Mapping)** | 工具字段与数据指标/要素的绑定 | `field_mappings` | `mapping_type = data_indicator | element` |
| **数据指标-要素关联** | 数据指标依赖哪些要素（primary/reference） | `data_indicator_elements` | 公式计算路径中会用到 `primary` 的派生要素 |
| **填报记录 (Submission)** | 某学校在某项目某工具的一次提交 | `submissions` | `data(JSON)` + `status(draft/submitted/approved/rejected)` |
| **指标采集值（落库）** | 项目×学校×数据指标的采集值与达标结果 | `school_indicator_data` | 由 submission 解析/计算后写入 |
| **资源配置 7 项指标** | 区县工作台专用统计 L1-L7 + 综合达标 | `backend/routes/statistics.js` | 与指标体系并行，不依赖映射/落库 |

---

## 二、实体关系图（实现视角）

```
projects (1) ── indicator_system_id ──> indicator_systems (1)
   │
   └─< project_tools (N) >─ data_tools (N)
                         │
                         └─< field_mappings (N)
                              ├─ mapping_type=data_indicator ──> data_indicators
                              └─ mapping_type=element ─────────> elements

indicator_systems (1) ──< indicators (N, parent_id 自引用树)
                          ├─< data_indicators (N)
                          │     └─< data_indicator_elements (N) >─ elements (N)
                          └─< supporting_materials (N)

submissions (N) ──(project_id, school_id, tool/form)─┐
                                                      └─ sync/计算 ──> school_indicator_data (N)
```

---

## 三、关键表与关键字段（按实现使用频率）

### 3.1 项目与状态流转

- `projects.status`：`配置中 → 填报中 → 评审中 → 已完成`（或任意状态可 `已中止`）
- 项目启动填报存在“必须已发布”的校验（实现中读取 `projects.is_published`）

### 3.2 指标体系（树）与数据指标

- `indicators` 扁平存储，通过 `parent_id` 形成树（最多3级）
- `data_indicators` 绑定末级指标（`indicator_id` 指向 `indicators.id`）
- 达标判定在"指标值同步"时基于 `data_indicators.threshold`（字符串阈值）进行

**data_indicators 表核心字段**（实际实现）：
```sql
CREATE TABLE data_indicators (
  id, indicator_id, code, name,
  threshold,        -- 阈值标准（如 "≥95%"）
  description,
  data_source,      -- 数据来源说明
  sort_order,
  created_at, updated_at
);
```

**注意**：早期设计中包含 `data_type`、`unit`、`calculation_method`、`collection_frequency` 等字段，但实际实现中这些属性由 `elements` 表管理，通过 `data_indicator_elements` 关联表建立联系。详见《评估指标、评估要素与采集表单关系分析》文档。

### 3.3 要素库、要素与公式

- `elements.element_type`：`基础要素 | 派生要素`
- `elements.formula`：派生要素公式，支持两种计算模式：
  - **基础公式**：变量形如 `E001/D001`，支持数字与四则运算、括号（如 `E001 / E002 * 100`）
  - **扩展公式**：支持 `SUM`, `AVG`, `COUNT`, `FILTER` 等聚合函数，可处理数组、对象等复杂数据结构

### 3.4 工具 schema 与字段映射（Field Mapping）

字段映射表结构：

- `field_mappings.tool_id`
- `field_mappings.field_id`（对应 schema 字段 id）
- `field_mappings.mapping_type`：`data_indicator | element`
- `field_mappings.target_id`：目标 id（数据指标 id 或要素 id）

### 3.5 数据指标-要素关联（Data Indicator Elements）

- `data_indicator_elements.mapping_type`：`primary | reference`
- 实现中的公式计算路径会按项目指标体系查询：**只取 `mapping_type='primary'` 且关联要素 `formula` 非空** 的数据指标作为“可计算指标”

### 3.6 Submission 与指标采集值落库

实现里存在一条核心链路：

- `submissions.data(JSON)` → 解析字段（支持扁平 key 与 `a.b.c` 路径，数组路径会求和）
- 写入/更新 `school_indicator_data`（upsert on `project_id,school_id,data_indicator_id`）
- 同步时计算 `is_compliant`（1/0/NULL）

---

## 四、数据流（配置 → 填报 → 指标同步 → 统计）

### 4.1 配置阶段数据流

```
创建指标体系 → 构建指标树(1/2/3级) → 末级配置数据指标/佐证资料
创建要素库 → 定义基础要素/派生要素(公式)
创建采集工具(schema) → 配置字段映射(field_mappings)
创建项目 → 关联指标体系 → 关联采集工具(project_tools) → 发布/启动填报
```

### 4.2 填报阶段数据流

```
学校/填报人 → 选择项目 + 工具 → 填写 schema 字段 → 生成 submissions(data,status,...)
```

### 4.3 指标同步阶段（把 submission 转成可统计的指标数据）

同步逻辑（实现支持两条路径）：

**路径1：直接映射**
- `field_mappings(mapping_type=data_indicator)` 直接把字段值写入对应 `data_indicator_id`
- 支持扁平 key 和 `a.b.c` 路径读取
- 遇到数组路径时会对数值字段求和

**路径2：要素 + 公式计算**
- `field_mappings(mapping_type=element)` 提取基础要素值
- 查找 `data_indicator_elements(primary)` 关联到带 `formula` 的派生要素
- 公式计算分两种模式：
  - **基础模式**：简单的四则运算（变量替换 + eval）
  - **扩展模式**：检测到扩展函数关键字时启用，支持数组聚合、条件筛选等
- **重要**：若该指标已被直接映射提供值，则公式计算不覆盖（直接映射优先级更高）

最终落库：

- 写入 `school_indicator_data(value/text_value/is_compliant/submission_id/collected_at)`
- `is_compliant` 根据 `data_indicators.threshold` 自动判定（1/0/NULL）

**实现位置**：`backend/routes/submissions.js` 中的 `syncSubmissionIndicators` 函数

### 4.4 统计阶段数据流（通用统计 vs 内置资源指标）

#### A. 通用统计（基于 `school_indicator_data`）

- 达标率统计：从 `school_indicator_data.is_compliant` 聚合
- 项目 CV 分析：以学校基础数据的生师比为基础，并可扩展到 `school_indicator_data` 中的更多指标

相关接口示例：

- `GET /api/projects/:projectId/compliance-summary`
- `GET /api/projects/:projectId/compliance-by-category`
- `GET /api/projects/:projectId/cv-analysis`
- `GET /api/projects/:projectId/cv-summary`

#### B. 区县工作台资源配置 7 项指标（内置模型）

特点：

- 不依赖指标体系/字段映射/`school_indicator_data`
- 直接读取 `submissions.data` 中约定字段计算 L1-L7
- submission 选择策略：优先 `approved`，否则最新 `submitted/rejected`，排除 `draft`；无有效 submission 时指标值返回 `null`
- 额外输出：每校综合达标（至少 6 项达标 + 其余≥85%）与 `overallComplianceDetails`

接口：

- `GET /api/districts/:districtId/resource-indicators-summary?projectId=...&schoolType=小学|初中`

---

## 五、页面/模块与数据关系（对照实现）

| 模块 | 前端页面/服务 | 后端路由 | 关键数据 |
|---|---|---|---|
| 指标体系管理 | `frontend/src/services/indicatorService.ts` | `backend/routes/indicators.js` | `indicator_systems / indicators / data_indicators / supporting_materials` |
| 数据指标-要素关联 | `indicatorService.ts`（elements 相关 API） | `indicators.js`（`/data-indicators/:id/elements`） | `data_indicator_elements` |
| 要素库/要素管理 | （要素库相关页面） | `backend/routes/tools.js`（elements CRUD） | `element_libraries / elements` |
| 工具与字段映射 | （工具编辑/字段映射 UI） | `backend/routes/tools.js`（`/tools/:id/field-mappings`、`/tools/:id/full-schema`） | `data_tools.schema + field_mappings` |
| 填报与指标同步 | （填报页面） | `backend/routes/submissions.js` | `submissions → school_indicator_data` |
| 区县工作台资源指标 | `frontend/src/pages/DistrictDashboard/components/IndicatorSummary.tsx` | `backend/routes/statistics.js` | `submissions + schools + 内置 L1-L7` |

---

## 六、文档使用建议（避免概念混用）

- 当你在讨论"某指标是否达标/达标率"等**通用评估**时：默认指 **指标体系 → 数据指标 → school_indicator_data** 这条链路。
- 当你在讨论"7 项资源配置指标、综合达标（6/7 + 85%）"时：默认指 **statistics.js 内置模型**，不需要配置映射，也不需要数据指标存在。

---

## 七、关键注意事项与最佳实践

### 7.1 数据指标字段限制

**重要提示**：`data_indicators` 表不包含 `data_type`、`unit`、`calculation_method`、`collection_frequency` 等字段。如果需要这些属性：
- 应在 `elements` 表中定义
- 通过 `data_indicator_elements` 关联表与数据指标建立联系
- 详细说明请参考《评估指标、评估要素与采集表单关系分析》文档第三、四节

### 7.2 字段映射优先级

在指标同步时，同一数据指标的值来源优先级：
1. **直接映射（最高优先级）**：`field_mappings(mapping_type=data_indicator)`
2. **公式计算**：`field_mappings(mapping_type=element)` + 派生要素公式

如果一个数据指标同时配置了直接映射和公式计算，**直接映射的值会被保留**，公式计算不会覆盖。

### 7.3 公式计算模式选择

- **基础模式**：适用于简单的数值运算，如 `E001 / E002 * 100`
- **扩展模式**：适用于需要数组聚合、条件筛选的复杂场景，如 `SUM(E001) / COUNT(E001)`

系统会根据公式中是否包含扩展函数关键字（`SUM`、`AVG`、`COUNT`、`FILTER` 等）自动选择合适的计算模式。

### 7.4 submission 状态对统计的影响

- **通用统计**（基于 `school_indicator_data`）：所有状态的 submission 都会触发指标同步
- **资源配置7项指标**：只统计 `approved`/`submitted`/`rejected` 状态的 submission，`draft` 不纳入统计

### 7.5 文档间引用

本文档与以下文档相互配合使用：
- 《评估指标、评估要素与采集表单关系分析》：详细的表结构、类型定义、API接口
- 《项目-指标-要素-表单关系设计方案》：设计理念和关系图

---

## 八、更新日志

### v2.0 (2025-12-22)
- 添加版本号和更新时间
- 补充 data_indicators 表实际字段说明
- 更新公式计算说明，区分基础模式和扩展模式
- 完善指标同步流程描述
- 添加关键注意事项和最佳实践章节
- 明确字段映射优先级规则

