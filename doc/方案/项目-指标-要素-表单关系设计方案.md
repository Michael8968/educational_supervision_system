# 项目-指标-要素-表单关系设计方案

> 版本：v2.0
> 更新日期：2024-12-14
> 本文档描述教育督导评估系统中核心实体之间的关系和数据流动。

---

## 一、核心概念

| 概念 | 说明 | 数据库表 |
|------|------|----------|
| **项目 (Project)** | 评估项目，整合指标体系和采集工具，驱动整个评估流程 | `projects` |
| **指标体系 (Indicator System)** | 评估标准的集合，采用三级树形结构 | `indicator_systems` |
| **指标 (Indicator)** | 评估标准的层级节点，分1/2/3级 | `indicators` |
| **数据指标 (Data Indicator)** | 末级指标下的具体量化数据项，含阈值 | `data_indicators` |
| **要素库 (Element Library)** | 可复用的数据要素集合 | `element_libraries` |
| **要素 (Element)** | 可复用的数据定义（基础要素/派生要素） | `elements` |
| **采集工具 (Data Tool)** | 数据采集表单或问卷 | `data_tools` |

---

## 二、实体关系总览

### 2.1 完整实体关系图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                              评估项目 (Project)                              │
│                                                                             │
│  id, name, status, indicator_system_id, start_date, end_date               │
│  状态: 配置中 → 填报中 → 评审中 → 已完成 (或 已中止)                          │
└───────────────────────────────┬─────────────────────────────────────────────┘
                                │
          ┌─────────────────────┴─────────────────────┐
          │ 1:1 关联                                  │ N:N 关联 (project_tools)
          ▼                                           ▼
┌─────────────────────────────────┐      ┌─────────────────────────────────┐
│      指标体系                    │      │      采集工具 (DataTool)         │
│      (IndicatorSystem)          │      │                                 │
│                                 │      │   id, name, type, schema        │
│   类型: 达标类 | 评分类          │      │   type: 表单 | 问卷              │
└─────────────┬───────────────────┘      └─────────────┬───────────────────┘
              │ 1:N                                    │ 1:N
              ▼                                        ▼
┌─────────────────────────────────┐      ┌─────────────────────────────────┐
│      指标 (Indicator)            │      │      字段映射 (FieldMapping)     │
│                                 │      │                                 │
│   三级树形结构:                  │      │   表单字段 → 要素                │
│   ├─ 一级指标 (level=1)         │      │   field_id → element_id         │
│   │  └─ 二级指标 (level=2)      │      │                                 │
│   │     └─ 三级指标 (level=3)   │      └────────────────┬────────────────┘
│   │        └─ 数据指标          │                       │
│   │        └─ 佐证资料          │                       │
└─────────────┬───────────────────┘                       │
              │ 1:N                                       │
              ▼                                           │
┌─────────────────────────────────┐                       │
│      数据指标 (DataIndicator)    │                       │
│                                 │                       │
│   id, code, name, threshold     │                       │
│   阈值定义达标标准               │                       │
└─────────────┬───────────────────┘                       │
              │                                           │
              │ N:N (data_indicator_elements)             │
              │                                           │
              ▼                                           ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                              要素 (Element)                                  │
│                                                                             │
│   id, code, name, element_type, data_type, formula                         │
│   element_type: 基础要素 | 派生要素                                          │
│   data_type: 文本 | 数字 | 日期 | 时间 | 逻辑 | 数组 | 文件                   │
└─────────────────────────────────────────────────────────────────────────────┘
                                ▲
                                │ 1:N
┌─────────────────────────────────────────────────────────────────────────────┐
│                           要素库 (ElementLibrary)                            │
│                                                                             │
│   id, name, description, element_count                                      │
│   如: 义务教育优质均衡评估要素库                                               │
└─────────────────────────────────────────────────────────────────────────────┘
```

### 2.2 关系汇总表

| 实体A | 关系 | 实体B | 关联表/字段 | 说明 |
|-------|------|-------|-------------|------|
| 项目 | 1:1 | 指标体系 | `projects.indicator_system_id` | 每个项目选择一个指标体系 |
| 项目 | N:N | 采集工具 | `project_tools` | 项目可关联多个表单/问卷 |
| 指标体系 | 1:N | 指标 | `indicators.system_id` | 指标体系包含多级指标树 |
| 指标 | 1:N | 指标 | `indicators.parent_id` | 指标自引用形成树结构 |
| 指标 | 1:N | 数据指标 | `data_indicators.indicator_id` | 末级指标下有数据指标 |
| 指标 | 1:N | 佐证资料 | `supporting_materials.indicator_id` | 末级指标下有佐证资料 |
| **数据指标** | **N:N** | **要素** | `data_indicator_elements` | **数据指标关联评估要素** |
| 要素库 | 1:N | 要素 | `elements.library_id` | 要素库包含多个要素 |
| **采集工具** | **1:N** | **要素** | `field_mappings` | **表单字段映射到要素** |

---

## 三、核心关联详解

### 3.1 数据指标与要素的关联 (data_indicator_elements)

这是系统中最重要的关联，定义了**数据指标需要哪些要素来计算/支撑**。

```sql
CREATE TABLE data_indicator_elements (
  id TEXT PRIMARY KEY,
  data_indicator_id TEXT NOT NULL,        -- 数据指标ID
  element_id TEXT NOT NULL,               -- 评估要素ID
  mapping_type TEXT DEFAULT 'primary',    -- 关联类型: primary=主要, reference=参考
  description TEXT,                       -- 关联说明
  FOREIGN KEY (data_indicator_id) REFERENCES data_indicators(id),
  FOREIGN KEY (element_id) REFERENCES elements(id),
  UNIQUE (data_indicator_id, element_id)
);
```

**关联类型说明：**

| mapping_type | 含义 | 用途 |
|-------------|------|------|
| `primary` | 主要关联 | 该要素直接用于计算数据指标的值 |
| `reference` | 参考关联 | 该要素作为参考数据，辅助理解或校验 |

**示例：**

```
数据指标: "生师比" (D1-1-1)
├── 关联要素1: "学生数" (E001) - primary
├── 关联要素2: "专任教师数" (E002) - primary
└── 关联要素3: "学校类型" (E003) - reference (用于区分小学/初中标准)

计算公式: 生师比 = 学生数 / 专任教师数
```

### 3.2 表单字段与要素的映射 (field_mappings)

表单字段映射到要素，用于采集基础数据：

```sql
CREATE TABLE field_mappings (
  id TEXT PRIMARY KEY,
  tool_id TEXT NOT NULL,           -- 表单ID
  field_id TEXT NOT NULL,          -- 字段ID（在schema中定义）
  mapping_type TEXT DEFAULT 'element',  -- 映射类型: element
  target_id TEXT NOT NULL,         -- 要素ID
  UNIQUE(tool_id, field_id)
);
```

---

## 四、数据流路径

### 4.1 核心数据流：表单 → 要素 → 数据指标

```
┌─────────────┐     field_mappings      ┌─────────────┐    data_indicator_   ┌─────────────┐
│  表单字段    │ ──────────────────────► │    要素      │ ◄───elements────    │  数据指标    │
│  (填报值)   │                         │  (基础数据) │                      │  (计算/判定) │
└─────────────┘                         └─────────────┘                      └─────────────┘
       │                                      │                                    │
       │ 采集                                  │ 存储                               │ 关联
       ▼                                      ▼                                    ▼
   用户填写                               要素值入库                         根据关联要素计算
   原始数据                              (基础/派生)                          数据指标值
```

**数据流说明：**

1. **表单采集要素值**：用户通过表单填写数据，字段映射到具体要素
2. **要素存储基础数据**：基础要素直接存储采集值，派生要素通过公式计算
3. **数据指标关联要素**：数据指标通过 `data_indicator_elements` 关联所需要素
4. **计算指标值**：根据关联的要素值计算数据指标的最终值
5. **达标判定**：根据阈值判定数据指标是否达标

### 4.2 完整数据流图

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                           配置阶段                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐               │
│  │  创建要素库  │  ───► │  定义要素    │       │  创建指标体系│               │
│  └─────────────┘       └─────────────┘       └──────┬──────┘               │
│                              │                      │                       │
│                              │                      ▼                       │
│                              │               ┌─────────────┐               │
│                              │               │ 配置数据指标 │               │
│                              │               └──────┬──────┘               │
│                              │                      │                       │
│                              │      关联            │                       │
│                              └──────────────────────┤                       │
│                                                     ▼                       │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐               │
│  │  创建表单    │  ───► │  配置字段    │  ───► │ 字段映射要素 │               │
│  └─────────────┘       └─────────────┘       └─────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           填报阶段                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐               │
│  │  用户填报    │  ───► │  表单字段值  │  ───► │  要素值入库  │               │
│  └─────────────┘       └─────────────┘       └─────────────┘               │
│                                                     │                       │
│                                                     │ 派生计算              │
│                                                     ▼                       │
│                                              ┌─────────────┐               │
│                                              │ 派生要素计算 │               │
│                                              └─────────────┘               │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           评估阶段                                           │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                             │
│  ┌─────────────┐       ┌─────────────┐       ┌─────────────┐               │
│  │ 汇总要素值   │  ───► │ 计算指标值   │  ───► │  达标判定    │               │
│  └─────────────┘       └─────────────┘       └─────────────┘               │
│        │                      │                      │                      │
│        │ 根据关联              │ 应用公式             │ 比对阈值             │
│        ▼                      ▼                      ▼                      │
│   data_indicator_        生师比=学生数/        达标 or 未达标              │
│   elements               教师数                                            │
│                                                                             │
└─────────────────────────────────────────────────────────────────────────────┘
```

---

## 五、数据库表结构

### 5.1 核心业务表

```sql
-- 项目表
projects (
  id, name, indicator_system_id, status, start_date, end_date
)

-- 指标体系表
indicator_systems (
  id, name, type, target, description, status
)

-- 指标表（树形结构）
indicators (
  id, system_id, parent_id, code, name, level, is_leaf, weight
)

-- 数据指标表
data_indicators (
  id, indicator_id, code, name, threshold, data_source
)

-- 佐证资料配置表
supporting_materials (
  id, indicator_id, code, name, file_types, max_size, required
)
```

### 5.2 要素相关表

```sql
-- 要素库表
element_libraries (
  id, name, description, element_count, status
)

-- 要素表
elements (
  id, library_id, code, name, element_type, data_type, formula
)

-- 数据指标-要素关联表
data_indicator_elements (
  id, data_indicator_id, element_id, mapping_type, description
)
```

### 5.3 采集工具相关表

```sql
-- 采集工具表
data_tools (
  id, name, type, target, schema, status
)

-- 项目-工具关联表
project_tools (
  id, project_id, tool_id, sort_order, is_required
)

-- 字段映射表（字段 → 要素）
field_mappings (
  id, tool_id, field_id, mapping_type, target_id
)
```

### 5.4 数据采集表

```sql
-- 填报记录表
submissions (
  id, project_id, form_id, submitter_id, status, data
)

-- 学校指标数据表
school_indicator_data (
  id, project_id, school_id, data_indicator_id, value, is_compliant
)
```

---

## 六、典型业务流程

### 6.1 配置阶段

```
1. 创建要素库
   └── 定义基础要素（学生数、教师数、校舍面积...）
   └── 定义派生要素（生师比 = 学生数/教师数）

2. 创建指标体系
   └── 构建三级指标树
   └── 为末级指标配置数据指标（含阈值）
   └── 为数据指标关联要素 ← 【指标-要素关联】

3. 创建采集工具（表单）
   └── 设计表单字段
   └── 配置字段映射到要素 ← 【表单-要素映射】

4. 创建评估项目
   └── 关联指标体系
   └── 添加采集工具
```

### 6.2 填报阶段

```
1. 填报人进入项目
2. 选择采集工具（表单）
3. 填写表单数据
4. 系统通过字段映射写入要素值
5. 派生要素自动计算
```

### 6.3 评估阶段

```
1. 根据数据指标关联的要素，汇总要素值
2. 计算数据指标值（应用公式或直接取值）
3. 根据阈值判定是否达标
4. 计算各级指标达标率
5. 生成评估报告
```

---

## 七、关系验证示例

### 示例：义务教育优质均衡评估 - 生师比指标

**指标体系结构：**
```
义务教育优质均衡评估指标体系
└── 1. 资源配置 (一级指标)
    └── 1.1 教师配置 (二级指标)
        └── 1.1.1 生师比 (三级指标/末级)
            └── D1-1-1 小学生师比 (数据指标, 阈值: ≤19:1)
                ├── 关联要素: E001 学生数 (primary)
                └── 关联要素: E002 专任教师数 (primary)
```

**要素库：**
```
义务教育优质均衡评估要素库
├── E001 学生数 (基础要素, 数字) ← 表单采集
├── E002 专任教师数 (基础要素, 数字) ← 表单采集
└── E003 生师比 (派生要素, 公式: E001/E002) ← 自动计算
```

**采集表单：**
```
学校基本信息采集表
├── 字段: student_count → 映射到要素 E001 (学生数)
└── 字段: teacher_count → 映射到要素 E002 (专任教师数)
```

**数据流：**
```
1. 用户填写: student_count = 500, teacher_count = 32
2. 系统存储: E001(学生数) = 500, E002(专任教师数) = 32
3. 派生计算: E003(生师比) = 500 / 32 = 15.625
4. 指标取值: D1-1-1 从关联要素 E003 获取值 = 15.625
5. 达标判定: 15.625 ≤ 19 → 达标
```

---

## 八、设计原则

1. **要素是数据基础**：所有数据采集都通过要素进行，保证数据复用性
2. **指标关联要素**：数据指标通过关联要素定义其数据来源和计算方式
3. **表单映射要素**：表单字段直接映射到要素，不直接映射数据指标
4. **派生计算自动化**：派生要素根据公式自动计算，减少手工输入

---

## 九、总结

### 四者的核心职责

| 概念 | 回答的问题 |
|------|-----------|
| **指标体系** | 评什么？标准是什么？ |
| **要素库** | 有哪些可复用的数据定义？ |
| **采集工具** | 怎么采集数据？ |
| **项目** | 谁来组织？什么时候做？ |

### 核心关联

| 关联 | 作用 |
|------|------|
| 数据指标 ↔ 要素 | 定义指标需要哪些数据来计算 |
| 表单字段 → 要素 | 采集基础数据 |

### 数据流闭环

```
要素定义(what) → 表单设计(how) → 数据采集(do) → 派生计算(calc) → 指标取值(get) → 达标判定(check)
```

### 简化关系图

```
                    ┌─────────────┐
                    │   指标体系   │
                    └──────┬──────┘
                           │
                           ▼
                    ┌─────────────┐         关联         ┌─────────────┐
                    │   数据指标   │ ◄─────────────────── │    要素      │
                    │   (阈值)    │  data_indicator_    │  (基础/派生) │
                    └─────────────┘     elements        └─────────────┘
                                                               ▲
                                                               │ 映射
                                                               │ field_mappings
                                                        ┌──────┴──────┐
                                                        │   表单字段   │
                                                        └─────────────┘
```
