# 填报人员与采集工具配置实现方案

## 一、需求分析

### 1.1 业务背景
在优质均衡评估项目配置中，目前已实现：
- ✅ 指标体系配置
- ✅ 采集工具配置
- ✅ 填报学校配置
- ✅ 填报人员配置

**待实现功能**：配置填报人员与采集工具的关联关系，即指定哪些填报人员可以使用哪些采集工具进行数据填报。

### 1.2 功能目标
1. **权限控制**：为每个填报人员配置可使用的采集工具列表
2. **灵活配置**：支持多对多关系（一个人员可配置多个工具，一个工具可分配给多个人员）
3. **可视化配置**：提供友好的界面进行批量配置和单独配置
4. **自动分配**：支持根据填报对象类型（区县/学校）自动匹配分配

### 1.3 使用场景
- **场景1**：项目管理员手动为每个填报人员分配可使用的采集工具
- **场景2**：根据采集工具的填报对象类型（区县/学校），自动分配给对应类型的填报员
- **场景3**：查看某个采集工具已分配给哪些填报人员
- **场景4**：查看某个填报人员可以使用哪些采集工具

---

## 二、数据模型设计

### 2.1 数据库表设计

#### 表名：`personnel_tool_permissions`

用于存储填报人员与采集工具的关联关系（多对多关系）。

```sql
CREATE TABLE IF NOT EXISTS personnel_tool_permissions (
  id TEXT PRIMARY KEY,
  project_id TEXT NOT NULL,              -- 关联 projects.id
  personnel_id TEXT NOT NULL,            -- 关联 project_personnel.id
  tool_id TEXT NOT NULL,                 -- 关联 data_tools.id
  created_at TEXT,
  updated_at TEXT,
  UNIQUE(project_id, personnel_id, tool_id)  -- 同一项目下，同一人员不能重复配置同一工具
);

-- 索引
CREATE INDEX IF NOT EXISTS idx_personnel_tool_permissions_project 
  ON personnel_tool_permissions(project_id);
CREATE INDEX IF NOT EXISTS idx_personnel_tool_permissions_personnel 
  ON personnel_tool_permissions(personnel_id);
CREATE INDEX IF NOT EXISTS idx_personnel_tool_permissions_tool 
  ON personnel_tool_permissions(tool_id);
```

### 2.2 数据关系图

```
项目 (projects)
  ├── 项目人员 (project_personnel)
  │     ├── 区县填报员 (district_reporter)
  │     └── 学校填报员 (school_reporter)
  │
  ├── 项目工具 (project_tools)
  │     └── 采集工具 (data_tools)
  │           ├── 填报对象：区县
  │           └── 填报对象：学校
  │
  └── 人员工具权限 (personnel_tool_permissions)  ← 新增表
        ├── 人员ID (personnel_id)
        └── 工具ID (tool_id)
```

### 2.3 与现有表的关系

- **project_personnel**：项目人员表，包含填报人员信息
- **project_tools**：项目与采集工具关联表
- **data_tools**：采集工具表，包含 `target` 字段（填报对象类型）
- **tasks**：任务分配表，可基于权限配置自动创建任务

---

## 三、后端API设计

### 3.1 API路由规划

在 `backend/routes/personnel.js` 中添加以下路由：

#### 3.1.1 获取项目的权限配置列表

```javascript
GET /api/projects/:projectId/personnel-tool-permissions
```

**功能**：获取项目下所有人员-工具权限配置

**查询参数**：
- `personnelId` (可选)：筛选特定人员
- `toolId` (可选)：筛选特定工具
- `role` (可选)：筛选特定角色的人员

**响应示例**：
```json
{
  "code": 200,
  "data": [
    {
      "id": "ptp-001",
      "projectId": "proj-001",
      "personnelId": "person-001",
      "personnelName": "张三",
      "personnelRole": "school_reporter",
      "personnelOrg": "XX小学",
      "toolId": "tool-001",
      "toolName": "学校基础数据采集表",
      "toolType": "表单",
      "toolTarget": "学校",
      "createdAt": "2024-01-01T00:00:00Z"
    }
  ]
}
```

#### 3.1.2 获取单个人员的工具权限

```javascript
GET /api/projects/:projectId/personnel/:personnelId/tool-permissions
```

**功能**：获取指定人员可使用的所有采集工具

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "personnelId": "person-001",
    "personnelName": "张三",
    "tools": [
      {
        "toolId": "tool-001",
        "toolName": "学校基础数据采集表",
        "toolType": "表单",
        "toolTarget": "学校"
      }
    ]
  }
}
```

#### 3.1.3 获取单个工具的人员权限

```javascript
GET /api/projects/:projectId/tools/:toolId/personnel-permissions
```

**功能**：获取指定工具已分配给哪些人员

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "toolId": "tool-001",
    "toolName": "学校基础数据采集表",
    "personnel": [
      {
        "personnelId": "person-001",
        "personnelName": "张三",
        "personnelRole": "school_reporter",
        "personnelOrg": "XX小学"
      }
    ]
  }
}
```

#### 3.1.4 批量配置权限

```javascript
POST /api/projects/:projectId/personnel-tool-permissions/batch
```

**功能**：批量配置人员-工具权限

**请求体**：
```json
{
  "configs": [
    {
      "personnelId": "person-001",
      "toolIds": ["tool-001", "tool-002"]
    },
    {
      "personnelId": "person-002",
      "toolIds": ["tool-001"]
    }
  ]
}
```

**响应示例**：
```json
{
  "code": 200,
  "data": {
    "success": 3,
    "failed": 0,
    "errors": []
  },
  "message": "批量配置成功：成功 3 条，失败 0 条"
}
```

#### 3.1.5 添加单个权限

```javascript
POST /api/projects/:projectId/personnel-tool-permissions
```

**请求体**：
```json
{
  "personnelId": "person-001",
  "toolId": "tool-001"
}
```

#### 3.1.6 删除单个权限

```javascript
DELETE /api/projects/:projectId/personnel-tool-permissions/:id
```

#### 3.1.7 批量删除权限

```javascript
POST /api/projects/:projectId/personnel-tool-permissions/batch-delete
```

**请求体**：
```json
{
  "ids": ["ptp-001", "ptp-002"]
}
```

#### 3.1.8 自动分配权限（根据填报对象类型）

```javascript
POST /api/projects/:projectId/personnel-tool-permissions/auto-assign
```

**功能**：根据采集工具的 `target` 字段自动分配给对应类型的填报员

**请求体**（可选）：
```json
{
  "targetType": "学校",  // 可选：筛选特定填报对象类型
  "override": false      // 是否覆盖已有配置
}
```

**分配规则**：
- 填报对象为"区县"的工具 → 分配给所有 `district_reporter`
- 填报对象为"学校"的工具 → 分配给所有 `school_reporter`
- 其他类型 → 默认分配给 `school_reporter`

---

## 四、前端界面设计

### 4.1 界面位置

在项目配置页面 (`/home/balanced/project/:projectId/config`) 的 **"人员配置"** Tab 中，添加一个新的子Tab或区域：

**方案A：在 PersonnelTab 中添加新区域**
- 在现有人员列表下方，添加"工具权限配置"区域

**方案B：新增独立Tab**
- 在项目配置页面新增"人员工具权限"Tab

**推荐方案A**，因为权限配置与人员管理紧密相关。

### 4.2 界面布局

```
┌─────────────────────────────────────────────────────────┐
│  人员配置 Tab                                            │
├─────────────────────────────────────────────────────────┤
│  [区县填报员列表]                                        │
│  [学校填报员列表]                                        │
│  ...                                                     │
├─────────────────────────────────────────────────────────┤
│  工具权限配置                                            │
│  ┌───────────────────────────────────────────────────┐ │
│  │ [自动分配] [批量配置] [清空配置]                   │ │
│  │                                                   │ │
│  │ 视图切换：[按人员查看] [按工具查看]                │ │
│  │                                                   │ │
│  │ ┌─────────────────────────────────────────────┐   │ │
│  │ │ 按人员查看                                  │   │ │
│  │ │ ┌──────────────┬────────────────────────┐ │   │ │
│  │ │ │ 人员          │ 已配置的工具            │ │   │ │
│  │ │ ├──────────────┼────────────────────────┤ │   │ │
│  │ │ │ 张三 (XX小学) │ [工具1] [工具2] [+添加]│ │   │ │
│  │ │ │ 李四 (YY小学) │ [工具1]        [+添加]│ │   │ │
│  │ │ └──────────────┴────────────────────────┘ │   │ │
│  │ └─────────────────────────────────────────────┘   │ │
│  │                                                   │ │
│  │ 或                                                │ │
│  │                                                   │ │
│  │ ┌─────────────────────────────────────────────┐   │ │
│  │ │ 按工具查看                                  │   │ │
│  │ │ ┌──────────────┬────────────────────────┐ │   │ │
│  │ │ │ 工具          │ 已分配的人员            │ │   │ │
│  │ │ ├──────────────┼────────────────────────┤ │   │ │
│  │ │ │ 学校基础数据  │ [张三] [李四] [+添加]  │ │   │ │
│  │ │ │ 教师专业发展  │ [张三]        [+添加]  │ │   │ │
│  │ │ └──────────────┴────────────────────────┘ │   │ │
│  │ └─────────────────────────────────────────────┘   │ │
│  └───────────────────────────────────────────────────┘ │
└─────────────────────────────────────────────────────────┘
```

### 4.3 核心功能

#### 4.3.1 自动分配功能

**按钮**：`自动分配权限`

**功能流程**：
1. 点击按钮，弹出确认对话框
2. 显示分配规则预览：
   - 区县类工具 → 分配给 X 个区县填报员
   - 学校类工具 → 分配给 Y 个学校填报员
3. 用户确认后执行自动分配
4. 显示分配结果（成功/失败数量）

#### 4.3.2 批量配置功能

**按钮**：`批量配置`

**功能流程**：
1. 打开批量配置弹窗
2. 左侧：选择人员（可多选，支持按角色筛选）
3. 右侧：选择工具（可多选，支持按类型/填报对象筛选）
4. 点击"确认"批量创建权限配置

#### 4.3.3 按人员查看

**表格列**：
- 人员信息（姓名、单位、角色）
- 已配置的工具（Tag列表，可删除）
- 操作（添加工具按钮）

**添加工具**：
- 点击"+添加"，弹出工具选择器
- 显示项目下所有已关联的采集工具
- 已配置的工具显示为已选状态
- 支持多选

#### 4.3.4 按工具查看

**表格列**：
- 工具信息（名称、类型、填报对象）
- 已分配的人员（Tag列表，可删除）
- 操作（添加人员按钮）

**添加人员**：
- 点击"+添加"，弹出人员选择器
- 显示项目下所有填报员
- 已分配的人员显示为已选状态
- 支持多选

#### 4.3.5 清空配置功能

**按钮**：`清空配置`

**功能**：删除项目下所有权限配置（需二次确认）

---

## 五、前端服务层设计

### 5.1 服务文件

创建 `frontend/src/services/personnelToolPermissionService.ts`

### 5.2 API方法

```typescript
// 权限配置类型
export interface PersonnelToolPermission {
  id: string;
  projectId: string;
  personnelId: string;
  personnelName?: string;
  personnelRole?: string;
  personnelOrg?: string;
  toolId: string;
  toolName?: string;
  toolType?: string;
  toolTarget?: string;
  createdAt: string;
}

// 获取权限配置列表
export async function getPermissions(
  projectId: string,
  params?: {
    personnelId?: string;
    toolId?: string;
    role?: string;
  }
): Promise<PersonnelToolPermission[]>

// 获取单个人员的工具权限
export async function getPersonnelPermissions(
  projectId: string,
  personnelId: string
): Promise<{ personnelId: string; personnelName: string; tools: ProjectTool[] }>

// 获取单个工具的人员权限
export async function getToolPermissions(
  projectId: string,
  toolId: string
): Promise<{ toolId: string; toolName: string; personnel: Personnel[] }>

// 批量配置权限
export async function batchSetPermissions(
  projectId: string,
  configs: Array<{ personnelId: string; toolIds: string[] }>
): Promise<{ success: number; failed: number; errors: string[] }>

// 添加单个权限
export async function addPermission(
  projectId: string,
  personnelId: string,
  toolId: string
): Promise<{ id: string }>

// 删除单个权限
export async function deletePermission(
  projectId: string,
  permissionId: string
): Promise<void>

// 批量删除权限
export async function batchDeletePermissions(
  projectId: string,
  ids: string[]
): Promise<{ deleted: number }>

// 自动分配权限
export async function autoAssignPermissions(
  projectId: string,
  options?: {
    targetType?: string;
    override?: boolean;
  }
): Promise<{ success: number; failed: number }>
```

---

## 六、实现步骤

### 6.1 数据库层

1. **创建数据表**
   - 在 `backend/database/schema.sql` 中添加 `personnel_tool_permissions` 表定义
   - 创建必要的索引

2. **数据库迁移**（如使用迁移工具）
   - 创建迁移脚本，确保现有数据库可以升级

### 6.2 后端层

1. **扩展路由文件**
   - 在 `backend/routes/personnel.js` 中添加权限配置相关的路由处理函数

2. **实现API逻辑**
   - 实现所有8个API端点
   - 添加数据验证和错误处理
   - 实现自动分配的业务逻辑

3. **测试API**
   - 使用 Postman 或 curl 测试所有API端点
   - 验证边界情况和错误处理

### 6.3 前端层

1. **创建服务层**
   - 创建 `personnelToolPermissionService.ts`
   - 实现所有API调用方法

2. **扩展组件**
   - 在 `PersonnelTab.tsx` 中添加权限配置区域
   - 或创建新的 `PersonnelToolPermissionTab.tsx` 组件

3. **实现UI功能**
   - 实现视图切换（按人员/按工具）
   - 实现自动分配功能
   - 实现批量配置功能
   - 实现添加/删除权限功能

4. **集成到项目配置页面**
   - 在项目配置页面中引入新组件
   - 确保数据同步和状态管理

### 6.4 测试与优化

1. **功能测试**
   - 测试所有配置场景
   - 测试自动分配逻辑
   - 测试批量操作

2. **性能优化**
   - 大数据量下的列表渲染优化
   - API请求优化（合并请求、缓存等）

3. **用户体验优化**
   - 添加加载状态
   - 添加操作反馈（成功/失败提示）
   - 优化界面布局和交互

---

## 七、注意事项

### 7.1 数据一致性

- **删除人员时**：需要级联删除该人员的所有权限配置
- **删除工具时**：需要级联删除该工具的所有权限配置
- **删除项目时**：需要级联删除项目的所有权限配置

### 7.2 权限验证

- 确保只有项目管理员可以配置权限
- 在任务分配时，需要验证人员是否有使用该工具的权限

### 7.3 与任务分配的关系

- 权限配置是**前置条件**，不是任务分配
- 可以基于权限配置自动创建任务（在任务分配Tab中）
- 权限配置主要用于控制填报人员可以看到和使用哪些工具

### 7.4 性能考虑

- 权限配置表需要建立合适的索引
- 批量操作时考虑使用事务
- 前端列表使用虚拟滚动（如果数据量大）

---

## 八、扩展功能（可选）

### 8.1 权限模板

支持保存权限配置为模板，在新项目中快速应用。

### 8.2 权限继承

支持按角色批量配置权限，新添加的人员自动继承角色权限。

### 8.3 权限审计

记录权限配置的变更历史，支持查看和回滚。

### 8.4 权限导出/导入

支持将权限配置导出为Excel，或从Excel导入配置。

---

## 九、总结

本方案提供了完整的"填报人员与采集工具配置"功能实现路径，包括：

1. ✅ **数据模型**：多对多关系表设计
2. ✅ **后端API**：8个核心API端点
3. ✅ **前端界面**：两种视图模式（按人员/按工具）
4. ✅ **核心功能**：自动分配、批量配置、单独配置
5. ✅ **实现步骤**：分层的实施计划

该方案与现有系统架构保持一致，可以无缝集成到项目中，为项目配置提供更灵活的权限管理能力。

